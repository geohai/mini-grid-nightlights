# Callaway & Sant'Anna Difference in Difference Analysis for a Staggered Treatment

This notebook uses the Callaway & Sant'Anna (2020) Difference in Difference analysis for a staggered treatment. 
The original paper can be found [here](https://www.sciencedirect.com/science/article/pii/S0304407620300253).
An online tutorial can be found [here](https://tilburgsciencehub.com/topics/analyze/causal-inference/did/staggered-did/).

## Load Packages
```{r}
library(tidyverse)
library(did)
library(lubridate)
library(sf)
```

## Notes
compare rural points by map class  
compare to built points  
compare to ocean juungle and desert points  
comapre to mini-grids  
compare to control sites  


## Read in the Dark Area Data, Clean, Re-export
```{r}
# read in data
africa_dark_df <- read_csv("data/dark_africa/nighttime_dark_gdf.csv")

# convert to sf
africa_dark_sf <- st_as_sf(africa_dark_df, wkt = "geometry", crs = 4326)

# add a column date_commissioned equal to December 1, 2013
africa_dark_sf <- africa_dark_sf %>%
    mutate(date_commissioned = as.Date("2013-12-01"))

# glimpse
glimpse(africa_dark_sf)

# visualize the sf with ggplot geom_sf with different colors for type
ggplot(africa_dark_sf) +
    geom_sf(aes(color = type)) +
    labs(title = "Dark Area Points Sampled for Controls", x = "Longitude", y = "Latitude") +
    theme_bw()

# export sf
saveRDS(africa_dark_sf, "./data/dark_africa/africa_dark_sf.rds")
```

## Read in the Mini-Grid Data
```{r}
# read in data
africa_minigrid_df <- read_csv("data/cluber/nighttime_cluber_gdf.csv")
glimpse(africa_minigrid_df)

# convert to sf with latitude and longitude columns into geometry
africa_minigrid_sf <- st_as_sf(africa_minigrid_df, coords = c("longitude", "latitude"), crs = 4326)

glimpse(africa_minigrid_sf)
# drop the columns country, customers, developer, site_name, source, and status
africa_minigrid_sf <- africa_minigrid_sf %>%
    select(-country, -customers, -developer, -site_name, -source, -status)

# add a column "type" with value "minigrid"
africa_minigrid_sf <- africa_minigrid_sf %>%
    mutate(type = "minigrid")

# visualize the sf with ggplot geom_sf with different colors for type
ggplot(africa_minigrid_sf) +
    geom_sf(aes(color = type)) +
    labs(title = "Mini-Grid Points for Treatment", x = "Longitude", y = "Latitude") +
    theme_bw()

# export sf
saveRDS(africa_minigrid_sf, "./data/dark_africa/africa_minigrid_sf.rds")
```

## Merge the Dark Area and Mini-Grid Data
```{r}
# read in the 2 sfs
africa_dark_sf <- readRDS("./data/dark_africa/africa_dark_sf.rds")
africa_minigrid_sf <- readRDS("./data/dark_africa/africa_minigrid_sf.rds")
glimpse(africa_minigrid_sf)
# merge the dfs
africa_sf <- bind_rows(africa_minigrid_sf, africa_dark_sf)
glimpse(africa_sf)
rm(africa_minigrid_sf, africa_dark_sf)

# rename Map to landcover
africa_sf <- africa_sf %>%
    mutate(landcover = as.factor(Map))
# drop Map column
africa_sf <- africa_sf %>%
    select(-Map)
# set type to factor
africa_sf$type <- as.factor(africa_sf$type)

# drop the first column ...1
africa_sf <- africa_sf %>%
    select(-1)
# create an id column with an integer for each row
africa_sf <- africa_sf %>%
    mutate(id = as.factor(as.integer(row_number())))

glimpse(africa_sf)

# visualize the sf with ggplot geom_sf with different colors for type
ggplot(africa_sf) +
    geom_sf(aes(color = type)) +
    labs(title = "Dark Area and Mini-Grid Points", x = "Longitude", y = "Latitude") +
    theme_bw()
# export combined sf
saveRDS(africa_sf, "./data/dark_africa/africa_sf.rds")
```

## Melt the Dataset
```{r}
# read in the sf
africa_sf <- readRDS("./data/dark_africa/africa_sf.rds")

# convert to df without geometry
africa_df <- st_drop_geometry(africa_sf)
rm(africa_sf)

# melt the df, keep the date_commissioned, type, landcover, and id columns
africa_df_melt <- africa_df %>%
    pivot_longer(cols = c(-date_commissioned, -type, -landcover, -id), names_to = "image_date", values_to = "image_value")
rm(africa_df)
# add dashes to the image_date column instead of 20140101 to 2014-01-01
africa_df_melt <- africa_df_melt %>%
    mutate(image_date = str_replace(image_date, "(\\d{4})(\\d{2})(\\d{2})", "\\1-\\2-\\3"))

# convert image_date to date
africa_df_melt$image_date <- as.Date(africa_df_melt$image_date)

# glimpse
glimpse(africa_df_melt)

# export df to csv
write_csv(africa_df_melt, "./data/dark_africa/africa_df_melt.csv")
# export sf to rds
saveRDS(africa_df_melt, "./data/dark_africa/africa_df_melt.rds")
```

## Visualize Raw Data
```{r}
# read in data
africa_df_melt <- readRDS("./data/dark_africa/africa_df_melt.rds")
glimpse(africa_df_melt)

# # exclude type "built"
africa_df_melt <- africa_df_melt %>%
    filter(type != "built")

# # exclude type "minigrid"
# africa_df_melt <- africa_df_melt %>%
#     filter(type != "minigrid")

# plot a histogram of image values with log(x) and log(y) scale
# color by log(x) in a linear scale
df %>%
    ggplot(aes(x = image_value)) +
    geom_histogram(bins = 100) +
    scale_x_log10() +
    scale_y_log10() +
    labs(title = "Histogram of Image Values", x = "Image Value", y = "Count") +
    theme_bw()

# create a line plot of image values over time colored by id
df %>%
    ggplot(aes(x = image_date, y = image_value, color = id)) +
    geom_line() +
    labs(title = "Image Values Over Time", x = "Image Date", y = "Image Value") +
    theme_bw() + 
    scale_y_log10()+
    # hide legend
    theme(legend.position = "none")

# create a smooth plot of image values by over time colored by type
africa_df_melt %>%
    ggplot(aes(x = image_date, y = image_value, color = type)) +
    geom_smooth() +
    labs(title = "Brightness Over Time by Type", x = "Image Date", y = "Image Value") +
    theme_bw()
```

## Look at Variances
```{r}
# read in data
africa_df_melt <- readRDS("./data/dark_africa/africa_df_melt.rds")
africa_df <- africa_df_melt

# calculate the standard deviation of all data points
sd_all <- sd(africa_df$image_value)
mean_all <- mean(africa_df$image_value)
min_all <- min(africa_df$image_value)
max_all <- max(africa_df$image_value)
median_all <- median(africa_df$image_value)

# calculate the standard deviation by type
africa_df_stats <- africa_df %>%
    group_by(type) %>%
    summarize(
        sd = sd(image_value),
        mean = mean(image_value),
        min = min(image_value),
        max = max(image_value),
        median = median(image_value)
    )

print(africa_df_stats)
 

# visualize as box and whisker plot
africa_df %>%
    ggplot(aes(x = type, y = image_value, fill = type)) +
    geom_boxplot() +
    labs(title = "Box and Whisker Plot of Image Values by Type", x = "Type", y = "Image Value") +
    # set ylim to -1, 3
    ylim(-0.25, 0.75) +
    theme_bw()
```
> print(dark_df_stats)

  type        sd  mean    min     max median
  <fct>    <dbl> <dbl>  <dbl>   <dbl>  <dbl>
1 built    8.31  5.29  -0.248   280.   2.18 
2 desert   0.126 0.193 -0.392   0.592  0.206
3 jungle   0.151 0.158 -0.460   4.05   0.151
4 minigrid 1.96  0.555 -0.413   72.3   0.235
5 ocean    0.143 0.172 -0.349   1.03   0.172
6 rural    0.960 0.203 -0.490   141.   0.181
~
Takeaways: 
1. Built is way brighter than the other types by a factor of 10
2. Rural has a much higher variance than the other types, likely because it has many different land cover types
3. Ocean has the lowest mean at 0.149, median of 1.57
4. Jungle has the second lowerst mean at 0.157, median of 0.151
5. Desert has the lowest variance at 0.123 compared to ocean at 1.34 and jungle at 0.151

# Outliers

## Import Data & Calculate Medians & IQRs by ID
```{r}
# read in data
africa_df_melt <- readRDS("./data/dark_africa/africa_df_melt.rds")
glimpse(africa_df_melt)
df <- africa_df_melt

# find the median for each id, put it into a new column
df$median <- ave(df$image_value, df$id, FUN = median)
# find the upper 75% quartile for each id, put it into a new column
df$q3 <- ave(df$image_value, df$id, FUN = function(x) quantile(x, 0.75))
# find the lower 25% quartile for each id, put it into a new column
df$q1 <- ave(df$image_value, df$id, FUN = function(x) quantile(x, 0.25))
# calculate the IQR for each id, put it into a new column
df$IQR <- df$q3 - df$q1
# calculate the top whisker for each id, put it into a new column
df$top_whisker <- df$q3 + 1.5 * df$IQR
# calculate the bottom whisker for each id, put it into a new column
df$bottom_whisker <- df$q1 - 1.5 * df$IQR

glimpse(df)

# convert any image_value that is above the top whisker to the top whisker
df <- df %>%
    mutate(image_value = ifelse(image_value > top_whisker, top_whisker, image_value))
# convert any image_value that is below the bottom whisker to the bottom whisker
df <- df %>%
    mutate(image_value = ifelse(image_value < bottom_whisker, bottom_whisker, image_value))

# drop the columns median, q1, q3, IQR, top_whisker, and bottom_whisker
df <- df %>%
    select(-median, -q1, -q3, -IQR, -top_whisker, -bottom_whisker)

# export 
saveRDS(df, "./data/dark_africa/africa_df_melt_clean.rds")
```


## Re-visualize Data After Cleaning Outliers
```{r}
# read in data
africa_df_melt_clean <- readRDS("./data/dark_africa/africa_df_melt_clean.rds")
df <- africa_df_melt_clean

# plot a histogram of image values with log(x) and log(y) scale
# color by log(x) in a linear scale
df %>%
    ggplot(aes(x = image_value)) +
    geom_histogram(bins = 100) +
    scale_x_log10() +
    scale_y_log10() +
    labs(title = "Histogram of Image Values", x = "Image Value", y = "Count") +
    theme_bw()

# create a line plot of image values over time colored by id
df %>%
    ggplot(aes(x = image_date, y = image_value, color = type)) +
    geom_line() +
    labs(title = "Image Values Over Time", x = "Image Date", y = "Image Value") +
    theme_bw() + 
    # hide legend
    theme(legend.position = "none")

# plot the data with geom_smooth
dark_smooth_plot <- df %>%
    filter(type != "built") %>%
    ggplot(aes(x = image_date, y = image_value, color = type)) +
    geom_smooth() +
    labs(title = "Nighttime Brightness Value Over Time by Site Type for CLUB-ER Sites", x = "Image Date", y = "Image Value") +
    theme_bw() +
    theme(text = element_text(size = 20, family = "serif")) +
    theme(legend.position = "bottom")
dark_smooth_plot
ggsave("figures/dark_africa/dark_smooth_plot.png", dark_smooth_plot, width = 16, height = 8, units = "in", dpi = 300)
```


# Difference in Difference Analysis

## Data Requirements
- There must be a unit-specific identifier variable that does not vary over time. Here that is site_name.
- There must be a time variable. Here that is image_date.
- There must be a group variable, which is usually the period when an individual first becomes treated. For units that are never treated, this variable should be set to 0! Here, we'll group by the date_commissioned variable.
- The variables must be of numeric class.
Note: this analysis can be run without control sites! Worth re-running on the CLUB-ER dataset. 

## Create a Treatment Group Variable
```{r}
# read in data
africa_df_melt_clean <- readRDS("./data/dark_africa/africa_df_melt_clean.rds")
df <- africa_df_melt_clean

glimpse(df)

# pull out the earliest date
start_date <- min(df$image_date)
end_date <- max(df$image_date)
start_year <- year(start_date)
end_year <- year(end_date)
start_month <- month(start_date)
end_month <- month(end_date)

# try the years
df$year_commissioned <- year(df$date_commissioned)
df$year_image <- year(df$image_date)

# extract months
df$month_commissioned <- month(df$date_commissioned)
df$month_image <- month(df$image_date)

# convert dates into months since first image
df$group <- (df$year_commissioned - start_year) * 12 + (df$month_commissioned - start_month) + 1 # 1 indexed
df$time_period <- (df$year_image - start_year) * 12 + (df$month_image - start_month) + 1 # 1 indexed

# convert id to numeric
df$id <- as.numeric(df$id)

# plot histogram of group variable
ggplot(df, aes(x = group)) +
    geom_histogram(binwidth = 1) +
    xlim(-5, 120) +
    scale_y_log10() +
    labs(title = "Histogram of Group Variable", x = "Group", y = "Log(Count)") +
    theme_bw()

# export df to csv
# View(df)
saveRDS(df, "./data/dark_africa/africa_df_melt_clean_for_csdind.rds")
```

## Run the Analysis
```{r}
# read in the data
africa_df_melt_clean_for_csdind <- readRDS("./data/dark_africa/africa_df_melt_clean_for_csdind.rds")
df <- africa_df_melt_clean_for_csdind

# keep only types minigrid and control group, whichever that is
df <- df %>%
    filter(type == "minigrid" | type == "rural")

# add 72 to every group variable for minigrid
df$group <- ifelse(df$type == "minigrid", df$group + 72, df$group)

# run the model
# https://bcallaway11.github.io/did/reference/att_gt.html
did_control <- att_gt(
    yname = "image_value", # outcome variable
    tname = "time_period", # time variable
    idname = "id", # id variable
    gname = "group", # first treatment period variable
    data = df, # data
    control_group = "nevertreated", # set the comparison group as either "never treated" or "not yet treated"
)

# export the model results
saveRDS(did_control, "./data/dark_africa/did_control_minigrid_rural_lag72.rds")

# aggregate the results
did_control_agg <- aggte(
    did_control,
    type = "dynamic", 
    na.rm = TRUE
)

# export the results
saveRDS(did_control_agg, "./data/dark_africa/did_control_agg_minigrid_rural_lag72.rds")

# read in the did model results
did_control_agg <- readRDS("./data/dark_africa/did_control_agg_minigrid_rural_lag72.rds")

# view the results
summary(did_control_agg)

# plot group-time ATTs
did_control_agg_plt <- ggdid(did_control_agg, xgap = 6) +
    labs(title = "ATTs for Mini-grid Sites vs Rural Sites with 72-Month Lag", x = "Months Since Commissioning - 72", y = "Change in Brightness") +
    theme_bw() + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
    theme(text = element_text(size = 24, family = "serif"), legend.position = "bottom")
ggsave("figures/dark_africa/did_control_agg_plt_minigrid_rural_lag72_wide.png", did_control_agg_plt, width = 16, height = 6, units = "in", dpi = 300)


print(did_control_agg_plt)
```

## Compile a Table of the Aggregated Results
```{r}
# read in the data
did_control_agg_minigrid_ocean <- readRDS("./data/dark_africa/did_control_agg_minigrid_ocean.rds")
did_control_agg_minigrid_desert <- readRDS("./data/dark_africa/did_control_agg_minigrid_desert.rds")
did_control_agg_minigrid_jungle <- readRDS("./data/dark_africa/did_control_agg_minigrid_jungle.rds")
did_control_agg_minigrid_rural <- readRDS("./data/dark_africa/did_control_agg_minigrid_rural.rds")
did_control_agg_minigrid_built <- readRDS("./data/dark_africa/did_control_agg_minigrid_built.rds")
did_nyt_agg_minigrid <- readRDS("./data/dark_africa/did_nyt_agg_minigrid.rds")

# print out summaries of each
summary(did_control_agg_minigrid_ocean)
summary(did_control_agg_minigrid_desert)
summary(did_control_agg_minigrid_jungle)
summary(did_control_agg_minigrid_rural)
summary(did_control_agg_minigrid_built)
summary(did_nyt_agg_minigrid)

# recreate the plots for each of these
did_nyt_agg_plt_minigrid <- ggdid(did_nyt_agg_minigrid, xgap = 6) +
    labs(title = "ATTs for Mini-grid Construction on Nighttime Brightness for 700+ Sites in Africa", x = "Months Since Commissioning", y = "Change in Brightness") +
    theme_bw() + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
    theme(text = element_text(size = 24, family = "serif"), legend.position = "bottom")

did_nyt_agg_plt_minigrid_small <- ggdid(did_nyt_agg_minigrid, xgap = 6) +
    labs(title = "ATTs for Mini-grid Construction on Nighttime Brightness for 700+ Sites in Africa", x = "Months Since Commissioning", y = "Change in Brightness") +
    theme_bw() + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
    theme(text = element_text(size = 14, family = "serif"), legend.position = "none")

did_control_agg_plt_minigrid_ocean <- ggdid(did_control_agg_minigrid_ocean, xgap = 6) +
    labs(title = "Group-Time ATTs for Mini-Grid Sites vs Ocean Sites", x = "Time Period in Months", y = "ATT") +
    theme_bw() + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
    theme(text = element_text(size = 14, family = "serif"), legend.position = "none")

did_control_agg_plt_minigrid_desert <- ggdid(did_control_agg_minigrid_desert, xgap = 6) +
    labs(title = "Group-Time ATTs for Mini-Grid Sites vs Desert Sites", x = "Time Period in Months", y = "ATT") +
    theme_bw() + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
    theme(text = element_text(size = 14, family = "serif"), legend.position = "none")  

did_control_agg_plt_minigrid_jungle <- ggdid(did_control_agg_minigrid_jungle, xgap = 6) +
    labs(title = "Group-Time ATTs for Mini-Grid Sites vs Rainforest Sites", x = "Time Period in Months", y = "ATT") +
    theme_bw() + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
    theme(text = element_text(size = 14, family = "serif"), legend.position = "none")

did_control_agg_plt_minigrid_rural <- ggdid(did_control_agg_minigrid_rural, xgap = 6) +
    labs(title = "Group-Time ATTs for Mini-Grid Sites vs Rural Sites", x = "Time Period in Months", y = "ATT") +
    theme_bw() + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
    theme(text = element_text(size = 14, family = "serif"), legend.position = "none")

did_control_agg_plt_minigrid_built <- ggdid(did_control_agg_minigrid_built, xgap = 6) +
    labs(title = "Group-Time ATTs for Mini-Grid Sites vs Built Sites", x = "Time Period in Months", y = "ATT") +
    theme_bw() + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
    theme(text = element_text(size = 14, family = "serif"), legend.position = "none")


# show them all
print(did_control_agg_plt_minigrid_ocean)
print(did_control_agg_plt_minigrid_desert)
print(did_control_agg_plt_minigrid_jungle)
print(did_control_agg_plt_minigrid_rural)
print(did_control_agg_plt_minigrid_built)
print(did_nyt_agg_plt_minigrid)

# export
ggsave("figures/dark_africa/did_nyt_agg_plt_minigrid.png", did_nyt_agg_plt_minigrid, width = 16, height = 10, units = "in", dpi = 300)
ggsave("figures/dark_africa/did_nyt_agg_plt_minigrid_small.png", did_nyt_agg_plt_minigrid_small, width = 6, height = 5, units = "in", dpi = 300)
ggsave("figures/dark_africa/did_control_agg_plt_minigrid_ocean.png", did_control_agg_plt_minigrid_ocean, width = 6, height = 5, units = "in", dpi = 300)
ggsave("figures/dark_africa/did_control_agg_plt_minigrid_desert.png", did_control_agg_plt_minigrid_desert, width = 6, height = 5, units = "in", dpi = 300)
ggsave("figures/dark_africa/did_control_agg_plt_minigrid_jungle.png", did_control_agg_plt_minigrid_jungle, width = 6, height = 5, units = "in", dpi = 300)
ggsave("figures/dark_africa/did_control_agg_plt_minigrid_rural.png", did_control_agg_plt_minigrid_rural, width = 6, height = 5, units = "in", dpi = 300)
ggsave("figures/dark_africa/did_control_agg_plt_minigrid_built.png", did_control_agg_plt_minigrid_built, width = 6, height = 5, units = "in", dpi = 300)

# for presentation
# ggsave("figures/dark_africa/did_nyt_agg_plt_minigrid_hires.png", did_nyt_agg_plt_minigrid, width = 12, height = 6, units = "in", dpi = 300)
```

## Results
### Mini-Grid vs Ocean
     ATT    Std. Error     [ 95%  Conf. Int.] 
 -0.0129        0.0175    -0.0473      0.0215 

### Mini-Grid vs Desert
   ATT    Std. Error     [ 95%  Conf. Int.] 
 0.034        0.0188    -0.0029       0.071 

### Mini-Grid vs Jungle
    ATT    Std. Error     [ 95%  Conf. Int.] 
 0.0232         0.018     -0.012      0.0584 

### Mini-Grid vs Rural
    ATT    Std. Error     [ 95%  Conf. Int.] 
 0.0421        0.0263    -0.0095      0.0937 

### Mini-Grid vs Built
    ATT    Std. Error     [ 95%  Conf. Int.]  
 -0.8998        0.1225      -1.14     -0.6596 *

### Mini-Grid vs Not Yet Treated
    ATT    Std. Error     [ 95%  Conf. Int.]
-0.0573        0.0741    -0.2026       0.088 