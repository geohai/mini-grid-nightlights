# Callaway & Sant'Anna Difference in Difference Analysis for a Staggered Treatment

This notebook uses the Callaway & Sant'Anna (2020) Difference in Difference analysis for a staggered treatment. 
The original paper can be found [here](https://www.sciencedirect.com/science/article/pii/S0304407620300253).
An online tutorial can be found [here](https://tilburgsciencehub.com/topics/analyze/causal-inference/did/staggered-did/).

## Load Packages
```{r}
library(tidyverse)
library(did)
library(lubridate)
library(sf)
```

## Notes
##############################################################################################################################################################################
##############################################################################################################################################################################
##############################################################################################################################################################################
##############################################################################################################################################################################
##############################################################################################################################################################################
##############################################################################################################################################################################
clean  
pull into R  
compare rural points by map class  
compare to built points  
compare to ocean juungle and desert points  
comapre to mini-grids  
compare to control sites  


## Read in the Dark Area Data, Clean, Re-export
```{r}
# read in data
africa_dark_df <- read_csv("data/dark_africa/nighttime_dark_gdf.csv")

# convert to sf
africa_dark_sf <- st_as_sf(africa_dark_df, wkt = "geometry", crs = 4326)

# add a column date_commissioned equal to December 1, 2013
africa_dark_sf <- africa_dark_sf %>%
    mutate(date_commissioned = as.Date("2013-12-01"))

# glimpse
glimpse(africa_dark_sf)

# visualize the sf with ggplot geom_sf with different colors for type
ggplot(africa_dark_sf) +
    geom_sf(aes(color = type)) +
    labs(title = "Dark Area Points Sampled for Controls", x = "Longitude", y = "Latitude") +
    theme_bw()

# export sf
saveRDS(africa_dark_sf, "./data/dark_africa/africa_dark_sf.rds")
```

## Read in the Mini-Grid Data
```{r}
# read in data
africa_minigrid_df <- read_csv("data/cluber/nighttime_cluber_gdf.csv")
glimpse(africa_minigrid_df)

# convert to sf with latitude and longitude columns into geometry
africa_minigrid_sf <- st_as_sf(africa_minigrid_df, coords = c("longitude", "latitude"), crs = 4326)

glimpse(africa_minigrid_sf)
# drop the columns country, customers, developer, site_name, source, and status
africa_minigrid_sf <- africa_minigrid_sf %>%
    select(-country, -customers, -developer, -site_name, -source, -status)

# add a column "type" with value "minigrid"
africa_minigrid_sf <- africa_minigrid_sf %>%
    mutate(type = "minigrid")

# visualize the sf with ggplot geom_sf with different colors for type
ggplot(africa_minigrid_sf) +
    geom_sf(aes(color = type)) +
    labs(title = "Mini-Grid Points for Treatment", x = "Longitude", y = "Latitude") +
    theme_bw()

# export sf
saveRDS(africa_minigrid_sf, "./data/dark_africa/africa_minigrid_sf.rds")
```

## Merge the Dark Area and Mini-Grid Data
```{r}
# read in the 2 sfs
africa_dark_sf <- readRDS("./data/dark_africa/africa_dark_sf.rds")
africa_minigrid_sf <- readRDS("./data/dark_africa/africa_minigrid_sf.rds")

# merge the dfs
africa_sf <- bind_rows(africa_minigrid_sf, africa_dark_sf)
glimpse(africa_sf)
rm(africa_minigrid_sf, africa_dark_sf)

# rename Map to landcover
africa_sf <- africa_sf %>%
    mutate(landcover = as.factor(Map))
# drop Map column
africa_sf <- africa_sf %>%
    select(-Map)
# set type to factor
africa_sf$type <- as.factor(africa_sf$type)

# drop the first column ...1
africa_sf <- africa_sf %>%
    select(-1)
# create an id column with an integer for each row
africa_sf <- africa_sf %>%
    mutate(id = as.factor(as.integer(row_number())))

glimpse(africa_sf)

# visualize the sf with ggplot geom_sf with different colors for type
ggplot(africa_sf) +
    geom_sf(aes(color = type)) +
    labs(title = "Dark Area and Mini-Grid Points", x = "Longitude", y = "Latitude") +
    theme_bw()
# export combined sf
saveRDS(africa_sf, "./data/dark_africa/africa_sf.rds")
```

## Melt the Dataset
```{r}
# read in the sf
africa_sf <- readRDS("./data/dark_africa/africa_sf.rds")

# convert to df without geometry
africa_df <- st_drop_geometry(africa_sf)
rm(africa_sf)

# melt the df, keep the date_commissioned, type, landcover, and id columns
africa_df_melt <- africa_df %>%
    pivot_longer(cols = c(-date_commissioned, -type, -landcover, -id), names_to = "image_date", values_to = "image_value")
rm(africa_df)
# add dashes to the image_date column instead of 20140101 to 2014-01-01
africa_df_melt <- africa_df_melt %>%
    mutate(image_date = str_replace(image_date, "(\\d{4})(\\d{2})(\\d{2})", "\\1-\\2-\\3"))

# convert image_date to date
africa_df_melt$image_date <- as.Date(africa_df_melt$image_date)

# glimpse
glimpse(africa_df_melt)

# export df to csv
write_csv(africa_df_melt, "./data/dark_africa/africa_df_melt.csv")
# export sf to rds
saveRDS(africa_df_melt, "./data/dark_africa/africa_df_melt.rds")
```

## Visualize Raw Data
```{r}
# read in data
africa_df_melt <- readRDS("./data/dark_africa/africa_df_melt.rds")
glimpse(africa_df_melt)

# # exclude type "built"
# africa_df_melt <- africa_df_melt %>%
#     filter(type != "built")

# create a smooth plot of image values by over time colored by type
africa_df_melt %>%
    ggplot(aes(x = image_date, y = image_value, color = type)) +
    geom_smooth() +
    labs(title = "Brightness Over Time by Type", x = "Image Date", y = "Image Value") +
    theme_bw()
```

## Visualize Spatially
```{r}
# read in data
africa_sf <- readRDS("./data/dark_africa/africa_sf.rds")

# create a dataframe with a grouping
africa_sf_by_site <- africa_sf %>%
    group_by(id) %>%
    summarize(
        mean = mean(image_value),
        median = median(image_value),
        min = min(image_value),
        max = max(image_value),
        sd = sd(image_value),
        type = first(type),
        landcover = first(landcover)
    )
glimpse(africa_sf_by_site)

# plot each point with geom_sf and color by type, size by median
africa_sf_by_site %>%
    ggplot() +
    geom_sf(aes(color = type, size = median)) +
    labs(title = "Spatial Distribution of Image Values by Type", x = "Longitude", y = "Latitude") +
    theme_bw()

# export africa_sf_by_site to csv and RDS
write_csv(africa_sf_by_site, "./data/dark_africa/africa_sf_by_site.csv")
saveRDS(africa_sf_by_site, "./data/dark_africa/africa_sf_by_site.rds")

```


## Look at Variances
```{r}
# read in data
africa_sf <- readRDS("./data/dark_africa/africa_sf.rds")

# convert to df and drop geometry column
africa_df <- st_drop_geometry(africa_sf)

# calculate the standard deviation of all data points
sd_all <- sd(africa_df$image_value)
mean_all <- mean(africa_df$image_value)
min_all <- min(africa_df$image_value)
max_all <- max(africa_df$image_value)
median_all <- median(africa_df$image_value)

# calculate the standard deviation by type
africa_df_stats <- africa_df %>%
    group_by(type) %>%
    summarize(
        sd = sd(image_value),
        mean = mean(image_value),
        min = min(image_value),
        max = max(image_value),
        median = median(image_value)
    )

print(africa_df_stats)
 

# visualize as box and whisker plot
africa_df %>%
    ggplot(aes(x = type, y = image_value, fill = type)) +
    geom_boxplot() +
    labs(title = "Box and Whisker Plot of Image Values by Type", x = "Type", y = "Image Value") +
    # set ylim to -1, 3
    ylim(-0.25, 0.75) +
    theme_bw()
```
> print(dark_df_stats)
# A tibble: 5 Ã— 6
  type       sd  mean    min    max median
  <fct>   <dbl> <dbl>  <dbl>  <dbl>  <dbl>
1 built  10.8   7.62   0     52.9    2.63 
2 desert  0.123 0.190 -0.392  0.535  0.205
3 jungle  0.151 0.157 -0.460  4.05   0.151
4 ocean   0.134 0.149 -0.497  1.13   0.157
5 rural   0.326 0.186 -0.475 38.5    0.184

Takeaways: 
1. Built is way brighter than the other types by a factor of 10
2. Rural has a much higher variance than the other types, likely because it has many different land cover types
3. Ocean has the lowest mean at 0.149, median of 1.57
4. Jungle has the second lowerst mean at 0.157, median of 0.151
5. Desert has the lowest variance at 0.123 compared to ocean at 1.34 and jungle at 0.151

########################################################################################################################
########################################################################################################################
########################################################################################################################
########################################################################################################################
########################################################################################################################
########################################################################################################################
########################################################################################################################
########################################################################################################################
########################################################################################################################
########################################################################################################################
########################################################################################################################
########################################################################################################################

Run DinD and ANOVA

## Handle Data Outliers
```{r}
# read in data
dark_sf <- read_csv("./data/dark_africa/dark_sf.csv")

# set any negative values to 0
dark_sf <- dark_sf %>%
    mutate(image_value = ifelse(image_value < 0, 0, image_value))

# calculate the standard deviation of all sites
sd_all <- sd(dark_sf$image_value)

# calculate the mean value per site
dark_sf <- dark_sf %>%
    group_by(id) %>%
    mutate(mean_image_value = mean(image_value)) %>%
    ungroup()

# calculate the max and min value for each site as the mean +/- 3 * sd
dark_sf <- dark_sf %>%
    mutate(min_image_value = mean_image_value - 3 * sd_all,
           max_image_value = mean_image_value + 3 * sd_all)

# count how many image values are above the max or below the min
n_outliers <- dark_sf %>%
    filter(image_value > max_image_value | image_value < min_image_value) %>%
    count()
print(n_outliers) # 67
print(nrow(dark_sf))  # 12862

# replace image_value with max if image_value > max and with min if image_value < min
dark_sf <- dark_sf %>%
    mutate(image_value = ifelse(image_value > max_image_value, max_image_value, image_value),
           image_value = ifelse(image_value < min_image_value, min_image_value, image_value))

# revisualize
dark_sf %>%
    ggplot(aes(x = image_date, y = image_value, color = id)) +
    geom_line() +
    labs(title = "Image Values Over Time", x = "Image Date", y = "Image Value") +
    theme_bw() + 
        # hide legend
    theme(legend.position = "none")

# export df to csv
write_csv(dark_sf, "./data/dark_africa/dark_sf_clean.csv")

# TODO >> try again dropping any values above the max
```

## NOTES FOR NEXT TIME
- Repeat the DinD analysis with the SL datasets
- Use trees and water as control sites instead of other villages
- Try with and without not-yet-treated sites as controls

## Data Requirements
- There must be a unit-specific identifier variable that does not vary over time. Here that is site_name.
- There must be a time variable. Here that is image_date.
- There must be a group variable, which is usually the period when an individual first becomes treated. For units that are never treated, this variable should be set to 0! Here, we'll group by the date_commissioned variable.
- The variables must be of numeric class.
Note: this analysis can be run without control sites! Worth re-running on the CLUB-ER dataset. 

## Create a Treatment Group Variable
```{r}
# read in data
df <- read_csv("./data/dark_africa/dark_sf_clean.csv")

# convert id variable to factor to integer
df$site_name <- as.factor(df$id)

# pull out the earliest date
start_date <- min(df$image_date)
end_date <- max(df$image_date)
start_year <- year(start_date)
end_year <- year(end_date)
start_month <- month(start_date)
end_month <- month(end_date)

# set the date commissioned for all Control sites to the earliest date
df$date_commissioned <- start_date

# try the years
df$year_commissioned <- year(df$date_commissioned)
df$year_image <- year(df$image_date)

# extract months
df$month_commissioned <- month(df$date_commissioned)
df$month_image <- month(df$image_date)

# convert dates into months since first image
df$group <- (df$year_commissioned - start_year) * 12 + (df$month_commissioned - start_month)
df$time_period <- (df$year_image - start_year) * 12 + (df$month_image - start_month)

# plot histogram of group variable
# set y max to 120
ggplot(df, aes(x = group)) +
    geom_histogram(bins = 100) +
    xlim(-5, 120) +
    labs(title = "Histogram of Group Variable", x = "Group", y = "Count") +
    theme_bw()

# export df to csv
# View(df)
write_csv(df, "./data/dark_africa/dark_sf_for_csdind.csv")
```

## Read in the Grid Data for DinD & Combine with Dark DF
```{r}
# read in the data
grid_df <- read_csv("./data/sl/nightlight_values_for_csdind.csv")
dark_sf <- read_csv("./data/dark_africa/dark_sf_for_csdind.csv")

# glimpse both dfs
glimpse(grid_df)
glimpse(dark_sf)

# set all negative image_value values to 0
grid_df <- grid_df %>%
    mutate(image_value = ifelse(image_value < 0, 0, image_value))


# rename dark_sf$id to dark_sf$site_name
dark_sf <- dark_sf %>%
    rename(site_name = id, site_type = type)

# drop dark_sf$center
dark_sf <- dark_sf %>%
    select(-center)

# bind the dfs
df <- bind_rows(grid_df, dark_sf)
glimpse(df)

# recreate site_id column with unique integers for each site_name
df$site_id <- as.integer(as.factor(df$site_name))

# visualize image_value by image_date for each site_id
df %>%
    ggplot(aes(x = image_date, y = image_value, color = site_name)) +
    geom_line() +
    labs(title = "Image Values Over Time by Site ID", x = "Image Date", y = "Image Value") +
    theme_bw() + 
        # hide legend
    theme(legend.position = "none")

# export df to csv
write_csv(df, "./data/dark_africa/dark_sf_plus_grids_for_csdind.csv")
```

## Visualize the Data Before Modeling
```{r}
# read in the data
df <- read_csv("./data/dark_africa/dark_sf_plus_grids_for_csdind.csv")

# change "CBIL" and "PowerGen" to "mini-grid"
# df$site_type <- ifelse(df$site_type == "CBIL" | df$site_type == "PowerGen", "mini-grid", df$site_type)
# change "Control" to "control"
df$site_type <- ifelse(df$site_type == "Control", "control", df$site_type)

# filter out PowerGen mini-grids
df <- df %>%
    filter(site_type != "PowerGen")

# change site type from CBIL to mini-grid
df$site_type <- ifelse(df$site_type == "CBIL", "village w/ mini-grid", df$site_type)

# change control to village
df$site_type <- ifelse(df$site_type == "control", "village w/o mini-grid", df$site_type)

# change tree to forest
df$site_type <- ifelse(df$site_type == "tree", "forest", df$site_type)

# visualize image_value by image_date for each site_id
df %>%
    ggplot(aes(x = image_date, y = image_value, color = site_name)) +
    geom_line() +
    labs(title = "Image Values Over Time by Site ID", x = "Image Date", y = "Image Value") +
    theme_bw() + 
        # hide legend
    theme(legend.position = "none")



# color the dots in the scatter plot by site_type
# set water to blue, tree to green, control to yellow, and CBIL and PowerGen to red
df %>%
    ggplot(aes(x = image_date, y = image_value, color = site_type)) +
    # geom_point() +
    geom_smooth() +
    # geom_quantile() +
    labs(title = "Image Values Over Time by Site ID", x = "Image Date", y = "Image Value") +
    theme_bw() +
    scale_fill_manual(values=c("yellow", "red", "green", "blue"))

# replot with goem_smooth
df %>%
    ggplot(aes(x = image_date, y = image_value, color = site_type)) +
    geom_smooth( ) +
    labs(title = "Image Values Over Time by Site Type", x = "Year", y = "Nighttime Brightness (nW/sr/cm^2)") +
    theme_bw()
```

## Run the Analysis
```{r}
# read in the data
df <- read_csv("./data/dark_africa/dark_sf_plus_grids_for_csdind.csv")

# # filter out all observations with site_type = "Control"
df <- df %>%
    filter(site_type != "Control")
glimpse(df)

# run the model
# https://bcallaway11.github.io/did/reference/att_gt.html
did_control <- att_gt(
    yname = "image_value", # outcome variable
    tname = "time_period", # time variable
    idname = "site_id", # id variable
    gname = "group", # first treatment period variable
    data = df, # data
    control_group = "nevertreated", # set the comparison group as either "never treated" or "not yet treated"
)

summary(did_control)

# aggregate the results
did_control_agg <- aggte(
    did_control,
    type = "dynamic", 
    na.rm = TRUE
)

# view the results
summary(did_control_agg)

# plot group-time ATTs
did_control_agg_plt <- ggdid(did_control_agg) +
    labs(title = "Group-Time ATTs for Control Group", x = "Time Period", y = "ATT") +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

print(did_control_agg_plt)
```



## Rerun with years as time periods instead of months
```{r}
# read in the data
df <- read_csv("./data/dark_africa/dark_sf_plus_grids_for_csdind.csv")

# view data
glimpse(df)

# pull out the earliest date
start_date <- min(df$image_date)
end_date <- max(df$image_date)
start_year <- year(start_date)
end_year <- year(end_date)
start_month <- month(start_date)
end_month <- month(end_date)

# take the mean image value for each site for each year
df <- df %>%
    group_by(site_id, site_name, year_image, year_commissioned, site_type) %>%
    summarize(
        mean_image_value = mean(image_value),
        median_image_value = median(image_value)
    )

glimpse(df)

# create group variable
df$group <- df$year_commissioned - start_year + 1

# put all 'Control' sites into group 0
df$group[df$site_type == "Control"] <- 0
df$group[df$site_type == "tree"] <- 0
df$group[df$site_type == "water"] <- 0

# add a time period variable which is year_image - start_year
df$time_period <- df$year_image - start_year + 1

# glimpse the head
glimpse(df)

# export df to csv
write_csv(df, "./data/dark_africa/dark_sf_plus_grids_for_csdind_years.csv")
```

## Rerun the DinD Analysis with Years as Time Periods
```{r}
# read in the data
df <- read_csv("./data/dark_africa/dark_sf_plus_grids_for_csdind_years.csv")

# filter out all observations with site_type = "Control"
df <- df %>%
    filter(site_type != "Control")
    
# run the model
# https://bcallaway11.github.io/did/reference/att_gt.html
did_control <- att_gt(
    yname = "median_image_value", # outcome variable
    tname = "time_period", # time variable
    idname = "site_id", # id variable
    gname = "group", # first treatment period variable
    data = df, # data
    control_group = "nevertreated", # set the comparison group as either "never treated" or "not yet treated"
)

# aggregate the results
did_control_agg <- aggte(
    did_control,
    type = "dynamic", 
    na.rm = TRUE
)

# view the results
summary(did_control_agg)

# plot group-time ATTs
did_control_agg_plt <- ggdid(did_control_agg) +
    labs(title = "Average Treatment Effect for Villages with Mini-Grids", x = "Years from Commissioning", y = "Nighttime Brightness (nW/sr/cm^2)") +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

print(did_control_agg_plt)
```

## Rerun the DinD Analysis with Years as Time Periods for Each of the Three Groups
```{r}
# read in the data
df <- read_csv("./data/dark_africa/dark_sf_plus_grids_for_csdind_years.csv")

# just trees and mini-grids
df <- df %>%
    filter(site_type != "Control" & site_type != "water")

# run the model
# https://bcallaway11.github.io/did/reference/att_gt.html
did_control <- att_gt(
    yname = "median_image_value", # outcome variable
    tname = "time_period", # time variable
    idname = "site_id", # id variable
    gname = "group", # first treatment period variable
    data = df, # data
    control_group = "nevertreated", # set the comparison group as either "never treated" or "not yet treated"
)

# aggregate the results
did_control_agg <- aggte(
    did_control,
    type = "dynamic", 
    na.rm = TRUE
)

# view the results
summary(did_control_agg)

# plot group-time ATTs
did_control_agg_plt <- ggdid(did_control_agg) +
    labs(title = "Group-Time ATTs for Trees vs Mini-Grids", x = "Time Period", y = "ATT") +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

print(did_control_agg_plt)

# do it with villages and trees

# plot brightness over time for each of the sites 
# see where the bright one is
# color code by type of site to check visually
# think about it in terms of theories
# "Limitations of Using Nightlights for Rural Electrification Mapping"


```