# Staggered Traditional Difference in Difference Analysis

```{r}
# Load the data
library(tidyverse)
library(lubridate)
library(plm)
```

## Read in Data & View Summary Statistics
```{r}
# read in data
df <- read_csv("data/nightlight_values_v2.csv")

# check datatypes of each column
glimpse(df)

# count number of unique control sites
n_control <- df %>%
    filter(site_type == "Control") %>%
    count(site_name) %>% nrow()
print(n_control) # 40 sites

# count number of unique treatment sites
n_treatment <- df %>%
    filter(site_type == "PowerGen" | site_type == "CBIL") %>%
    count(site_name) %>% nrow()
print(n_treatment) # 47 sites

# pull out the earliest date
start_date <- min(df$image_date)
end_date <- max(df$image_date)
start_year <- year(start_date)
end_year <- year(end_date)
start_month <- month(start_date)
end_month <- month(end_date)

# plot histogram of image values
ggplot(df, aes(x = image_value)) +
    geom_histogram(bins = 100) +
    labs(title = "Histogram of Image Values", x = "Image Value", y = "Count") +
    theme_bw()

# examine image_values for each site over time to see if there are any outliers
df %>%
    ggplot(aes(x = image_date, y = image_value, color = site_name)) +
    geom_line() +
    labs(title = "Image Values Over Time", x = "Image Date", y = "Image Value") +
    theme_bw() + 
        # hide legend
    theme(legend.position = "none")

# plot the mean brightness by site with x labels sideways
df %>%
    group_by(site_name) %>%
    summarize(mean_image_value = mean(image_value)) %>%
    ggplot(aes(x = site_name, y = mean_image_value)) +
    geom_col() +
    labs(title = "Mean Image Value by Site", x = "Site Name", y = "Mean Image Value") +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) + 
    # hide legend
    theme(legend.position = "none")

```

## Data Cleaning
```{r}
# reread in data
df <- read_csv("./data/nightlight_values_v2.csv")

# remove the site Pepel
df <- df %>%
    filter(site_name != "Pepel")

# calculate the mean value per site
df <- df %>%
    group_by(site_name) %>%
    mutate(mean_image_value = mean(image_value)) %>%
    ungroup()

# calculate the standard deviation of all sites
sd_all <- sd(df$image_value)
print(sd_all)

# calculate the max and min value for each site as the mean +/- 3 * sd
df <- df %>%
    mutate(min_image_value = mean_image_value - 3 * sd_all,
           max_image_value = mean_image_value + 3 * sd_all)

# count how many image values are above the max or below the min
n_outliers <- df %>%
    filter(image_value > max_image_value | image_value < min_image_value) %>%
    count()
print(n_outliers) # 42 outliers out of 10,881 observations

# replace image_value with max if image_value > max and with min if image_value < min
df <- df %>%
    mutate(image_value = ifelse(image_value > max_image_value, max_image_value, image_value),
           image_value = ifelse(image_value < min_image_value, min_image_value, image_value))

# revisualize
df %>%
    ggplot(aes(x = image_date, y = image_value, color = site_name)) +
    geom_line() +
    labs(title = "Image Values Over Time", x = "Image Date", y = "Image Value") +
    theme_bw() + 
        # hide legend
    theme(legend.position = "none")
    
    

# do a histogram of image values
ggplot(df, aes(x = image_value)) +
    geom_histogram(bins = 100) +
    labs(title = "Histogram of Image Values", x = "Image Value", y = "Count") +
    theme_bw()

# much better!

# export df to csv
write_csv(df, "./data/nightlight_values_v2_clean.csv")
```

## Data Requirements
- There must be a unit-specific identifier variable that does not vary over time. Here that is site_name.
- There must be a time variable. Here that is image_date.
- There must be a group variable, which is usually the period when an individual first becomes treated. For units that are never treated, this variable should be set to 0! Here, we'll group by the date_commissioned variable.
- The variables must be of numeric class. 

## Create a Treatment Group Variable
```{r}
# read in data
df <- read_csv("./data/nightlight_values_v2_clean.csv")

# convert id variable to factor to integer
df$site_id <- as.integer(as.factor(df$site_name))

# set the date commissioned for all Control sites to the earliest date
df$date_commissioned[df$site_type == "Control"] <- start_date

# try the years
df$year_commissioned <- year(df$date_commissioned)
df$year_image <- year(df$image_date)

# extract months
df$month_commissioned <- month(df$date_commissioned)
df$month_image <- month(df$image_date)

# convert dates into months since first image
df$group <- (df$year_commissioned - start_year) * 12 + (df$month_commissioned - start_month)
df$time_period <- (df$year_image - start_year) * 12 + (df$month_image - start_month)

# create a variable for the number of months since a site was treated
df$months_since_treatment <- df$time_period - df$group
# set negative values to 0
df$months_since_treatment <- ifelse(df$months_since_treatment < 0, 0, df$months_since_treatment)
# create a binary variable for treated or not

# plot histogram of group variable
# set y max to 120
ggplot(df, aes(x = group)) +
    geom_histogram(bins = 100) +
    xlim(-5, 120) +
    labs(title = "Histogram of Group Variable", x = "Group", y = "Count") +
    theme_bw()

# export df to csv
View(df)
write_csv(df, "./data/nightlight_values_for_csdind.csv")
```

## Run the Analysis
```{r}
# read in the data
df <- read_csv("./data/nightlight_values_for_csdind.csv")

staggered_did <- plm(
    image_value ~ site_name * time_period,
    data = df, 
    index = c("site_name", "time_period"), 
    model = "within"
)

summary(staggered_did)
# taking over 5 minutes to run :(
```