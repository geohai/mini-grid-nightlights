## Compare Mini-Grid Site Locations to Current Energy Access Maps

```{r}
library(tidyverse)
library(sf)
library(ggmap)
library(dotenv)
library(units)
```

## Configure the Maps APIs
```{r}
# read in env file
load_dot_env(".env")
google.maps.api.key <- Sys.getenv("GOOGLE_MAPS_API_KEY")
stadia.maps.api.key <- Sys.getenv("STADIA_MAPS_API_KEY")
register_google(google.maps.api.key)
register_stadiamaps(stadia.maps.api.key)
rm(google.maps.api.key, stadia.maps.api.key)
```

## Load & Merge the Mini-Grid Site Locations 
```{r}
# Load the mini-grid site locations from each developer

# cbil
cbil <- st_read("data/cbil/cbil_sites.geojson")
pg <- st_read("data/pg/pg_sites.geojson")
cluber <- st_read("data/cluber/cluber_sites.geojson")

# add source column to each
cbil <- cbil %>% mutate(source = "cbil", site_name = site)
pg <- pg %>% mutate(source = "pg")
cluber <- cluber %>% mutate(source = "cluber")

# clean up cbil df
cbil <- cbil %>% mutate(date_commissioned = as.Date(metadataprojectcod, format = "%Y-%m-%d"))
cbil <- cbil %>% select(site_name, country, date_commissioned, source, geometry)
glimpse(cbil)

# clean up pg df
glimpse(pg)
pg <- pg %>% select(site_name, country, date_commissioned, source, geometry)

# clean up cluber df
glimpse(cluber)
# keep only sites with status "Operating"
cluber <- cluber %>% filter(status == "Operating")
cluber <- cluber %>% select(site_name, country, date_commissioned, source, geometry)

# combine
mgs <- bind_rows(cbil, pg, cluber)
rm(cbil, pg, cluber)

# export
st_write(mgs, "data/mgs/mgs_operational.geojson")
```

## Filter Mini-Grid Sites by Country
```{r}
# read in mgs
mgs <- st_read("data/mgs/mgs_operational.geojson")
# countries of interest
iea <- c("Ghana", "Senegal", "Uganda")

# show unique list of countries from mgs
unique(mgs$country)

# [1] "Kenya"        "Sierra Leone" "DR Congo"     "Nigeria"      "Tanzania"    
#  [6] "Haiti"        "Zambia"       NA             "Ghana"        "Mozambique"  
# [11] "Benin"        "Angola"       "Burkina Faso" "Cameroon"     "Ethiopia"    
# [16] "Liberia"      "Madagascar"   "Mali"         "Mauritania"   "Senegal"     
# [21] "Togo"         "Uganda"       "Zimbabwe"    

# filter mgs by countries of interest
mgs <- mgs %>% filter(country %in% iea)
rm(iea)
# keeps 117 sites
# count number of mgs per developer
mgs %>% count(source)
# 4 from cbil, 25 from cluber
# count number per country
mgs %>% count(country)
# 6 for Ghana, 21 for Senegal, 2 for Uganda

# remove any two sites that are in the same location
mgs <- mgs %>% distinct(site_name, .keep_all = TRUE)
# remove any two sites that have identical geometry
mgs <- mgs %>% distinct(geometry, .keep_all = TRUE)

# map where remaining sites are
ggplot(mgs) +
  geom_sf(aes(color = country)) +
  theme_minimal()

# export 
st_write(mgs, "data/oemap/mgs_iea_29.geojson")
```

## Import OE Map GeoJSON Data
```{r}
grid_cells <- st_read("data/oemap/grid_cells.geojson")
mgs <- st_read("data/oemap/mgs_iea_29.geojson")

# # visualize the gridcells
# ggplot(grid_cells) +
#   geom_sf() +
#   theme_minimal()

# Clean geometries
grid_cells <- st_make_valid(grid_cells)
mgs <- st_make_valid(mgs)

# filter the grid cells for just the ones that contain a mini-grid site within them
grid_cells_mgs <- st_join(grid_cells, mgs, join = st_contains)

# filter just the ones that have a mini-grid site within them
grid_cells_mgs <- grid_cells_mgs %>% filter(!is.na(site_name))

# export
st_write(grid_cells_mgs, "data/oemap/grid_cells_mgs_29.geojson", delete_dsn = TRUE)

# remove objects
rm(grid_cells, mgs)
```

## Clean Up the OE Map Download Links
Todo: update this section now that the issue has been resolved in the GitHub repo.
```{r}
# read in grid cells with mini-grid sites
download_links <- read_csv("data/oemap/download_links.csv")

# format for link
# Working: https://biospheric-vector.s3.amazonaws.com/open-energy-maps/2024Q1-downloads-2/20240326-2/SEN/435853_geoms.zip
# Broken: https://biospheric-vector.s3.amazonaws.com/open-energy-maps/2024Q1-downloads/20240326/GHA/471928_geoms.geojson

# replace .geojson with .zip at the end of each cell in the column download_link
download_links$download_link <- gsub(".geojson", ".zip", download_links$download_link)

# replace 2024Q1-downloads with 2024Q1-downloads-2 in the download_link column
download_links$download_link <- gsub("2024Q1-downloads", "2024Q1-downloads-2", download_links$download_link)

# replace /20240326/ with /20240326-2/ in the download_link column
download_links$download_link <- gsub("/20240326/", "/20240326-2/", download_links$download_link)

# reexport the download_links
write_csv(download_links, "data/oemap/download_links_fix.csv")
```

## Download the Building Level Data
```{r}
# read in the mg grid cells
grid_cells_mgs <- st_read("data/oemap/grid_cells_mgs_29.geojson")
# read in the download links
download_links <- read_csv("data/oemap/download_links_fix.csv")

# filter download links for just the grid cells with mini-grid sites
download_links <- download_links %>% filter(grid_cell_id %in% grid_cells_mgs$grid_cell_id)

# loop over the download links and download the data
for (i in 1:nrow(download_links)) {
  download.file(download_links$download_link[i], paste0("data/oemap/grid_cells_zip/", download_links$grid_cell_id[i], ".zip"))
}

# print the first row second column of download_links, don't cut it off
print(download_links$download_link[1], width = 1000)
```

## Unzip the Building Level Data
```{r}
# unzip all the files
files <- list.files("data/oemap/grid_cells_zip", full.names = TRUE)
lapply(files, unzip, exdir = "data/oemap/grid_cells_geojson")

# manually delete the license file
```

## Read in and Combine the OE GeoJSON files
```{r}
# read in the geojson files from oe into a single sf
files <- list.files("data/oemap/grid_cells_geojson", full.names = TRUE)

# read in the first file
# oedata <- st_read(files[1])

# loop over the rest of the files and bind them to the first file
# for (i in 2:length(files)) {
#   oedata <- bind_rows(oedata, st_read(files[i]))
# }

# redo this with lapply
oedata_list <- lapply(files, st_read)
oedata2 <- do.call(rbind, oedata_list)

rm(files)
# set crs to 4326
st_crs(oedata) <- 4326

# export as a single geojson
st_write(oedata, "data/oemap/oedata.geojson")
```

## Export the Mini-Grid Sites with Grid Cell IDs
```{r}
# read in the grid cells mgs
mgs <- st_read("data/oemap/mgs_iea_29.geojson")
mgs_grid_cells <- st_read("data/oemap/grid_cells_mgs.geojson")
# convert mgs_grid_cells to df
mgs_grid_cells <- st_drop_geometry(mgs_grid_cells)
mgs_grid_cells <- mgs_grid_cells %>% select(site_name, grid_cell_id)

# for each mini-grid in mgs pull in the grid_cell_id from mgs_grid_cells matching by site_name
mgs <- mgs %>% left_join(mgs_grid_cells, by = "site_name")
# clean the geometries
mgs <- st_make_valid(mgs)
# remove a duplicate site with grid_cell_id =  431520
mgs <- mgs %>% filter(grid_cell_id != 431520)
# remove sites with NA grid_cell_id
mgs <- mgs %>% filter(!is.na(grid_cell_id))

# export mgs with grid cell ids
st_write(mgs, "data/oemap/mgs_iea_28_with_cell_id.geojson", delete_dsn = TRUE)

# remove objects
rm(mgs, mgs_grid_cells)
```

## Convert to 1km Buffer
```{r}
# read in the mini-grid sites
mgs <- st_read("data/oemap/mgs_iea_28_with_cell_id.geojson")
# convert geometry from a point to 1km buffer
mgs <- mgs %>% st_buffer(1000)

# calcualte the area of one of the mini-grid sites
st_area(mgs[14,])

# export the mini-grid sites with the buffer
# note that this won't work if the file is already written
st_write(mgs, "data/oemap/mgs_28_buffer_1km.geojson", delete_dsn = TRUE)
```
###############################################################################
###############################################################################
###############################################################################


## Visualize the Mini-Grid Site with Buffer
```{r}
# read in the data
mgs <- st_read("data/oemap/mgs_28_buffer_1km.geojson")
sample_mg <- mgs[14,]

# get the center
center <- c(
  lon = st_coordinates(st_centroid(sample_mg$geometry))[1, 1],
  lat = st_coordinates(st_centroid(sample_mg$geometry))[1, 2]
)

# get a new satellite map centered around these coordinates
map <- get_googlemap(
  center = center, 
  zoom = 16, 
  maptype = "satellite"
)
ggmap(map)
# export the map variable as RDS
saveRDS(map, "data/oemap/mg_14_map.rds")

ggmap(map) + 
  geom_sf(data = sample_mg, fill = NA, color = "yellow", lwd = 1, inherit.aes = FALSE)
# export this figure
ggsave("figures/oemap/mg_14_satmap.png", width = 12, height = 12, units = "in", dpi = 300)

rm(sample_mg, map, mgs, center)
```

## Analyze a Single Mini-Grid Site
```{r}
# read back in mg
mgs <- st_read("data/oemap/mgs_28_buffer_1km.geojson")

# for the first minigrid site, pull out the grid cell id
sample_mg <- mgs[14, ]
st_area(sample_mg) # ensure it's close to pi km2 to ensure 1km buffer is right

# create fileanme in format data/oemap/grid_cells_geojson/425749_geoms.geojson
filename <- paste0("data/oemap/grid_cells_geojson/", sample_mg$grid_cell_id, "_geoms.geojson")
grid_cell <- st_read(filename)

# make sure the geometries are valid
grid_cell <- st_make_valid(grid_cell)

# grab just the features from grid_cell that intersect with the first mini-grid site
inter <- st_intersection(grid_cell, sample_mg)

# calculate the mean of elec.access....
mean(inter$elec.access....)
nrow(inter)
sd(inter$elec.access....)

# find the centroid of sample_mg as it's own sf
sample_mg_pt <- st_centroid(sample_mg)

# set crs of sample_mg to 4326
st_crs(sample_mg) <- 4326
# set crs of inter to 4326
st_crs(inter) <- 4326
# caculate the distance from the village center to each building center
inter$distance <- st_distance(inter, sample_mg_pt)

# export inter as RDS
saveRDS(inter, "data/oemap/inter_14.rds")

# remove objects
rm(sample_mg, filename, grid_cell, inter, sample_mg_pt, mgs)
```

## Plot the Results
```{r}
# import data and map
mgs <- st_read("data/oemap/mgs_28_buffer_1km.geojson")
sample_mg <- mgs[14, ]
map <- readRDS("data/oemap/mg_14_map.rds")
inter <- readRDS("data/oemap/inter_14.rds")
inter <- inter %>%
  mutate(prob_elec_access = elec.access....)

# density plot of inter$elec.access....
ggplot(inter) +
  geom_density(aes(x = prob_elec_access), fill = "darkgreen", alpha = 0.5) +
  ggtitle("Density Plot of Electricity Access Probability by Building at a Mini-Grid Site") +
  labs(x = "Electricity Access Probability (%)", y = "Density") +
  theme_bw() 
  # theme(text = element_text(size = 24, family = "serif"), legend.position = "bottom")
ggsave("figures/oemap/density_by_building_14.png", width = 12, height = 6, units = "in", dpi = 300)

# scatterplot with gam of access probability by building with distance from village center
ggplot(inter) +
  geom_point(aes(x = distance, y = prob_elec_access)) +
  geom_smooth(aes(x = distance, y = prob_elec_access), method = "gam", se = TRUE) +
  ggtitle("Electricity Access Probability by Building at a Mini-Grid Site") +
  labs(x = "Distance from Village Center", y = "Electricity Access Probability (%)") +
  theme_bw() 
  # theme(text = element_text(size = 24, family = "serif"), legend.position = "bottom")
ggsave("figures/oemap/access_prob_by_distance_14.png", width = 12, height = 6, units = "in", dpi = 300)

# buildings sf with fill by prob_elec_access no background
ggplot() + 
  geom_sf(data = inter, aes(fill = prob_elec_access), inherit.aes = FALSE) +
  # geom_sf(data = sample_mg, fill = NA, color="blue", inherit.aes = FALSE) +
  # geom_sf(data = sample_mg_pt, color = "blue", size = 5, inherit.aes = FALSE) +
  scale_fill_viridis_c() +
  ggtitle("Electricity Access Probability by Building at a Mini-Grid Site") +
  theme_bw() + 
  # theme(text = element_text(size = 28, family = "serif")) +
  # move legend to the bottom
  theme(legend.position = "bottom")
  # remove long and lat axis labels
  # theme(axis.text.x = element_blank(), axis.text.y = element_blank()) 
  # add a scale bar
  # scalebar(x.min = left, x.max = right, y.min = bottom, y.max = top, dist = 1000, dist_unit = "m", st.dist = 0.1, st.dist_unit = "km")
ggsave("figures/oemap/access_prob_by_building_geom_sf_14_no_arc.png", width = 12, height = 12, units = "in", dpi = 300)

# buildings sf with fill by prob_elec_access satellite background
ggmap(map) +
  geom_sf(data = inter, aes(fill = prob_elec_access), inherit.aes = FALSE) +
  geom_sf(data = sample_mg, fill = NA, color="blue", inherit.aes = FALSE) +
  # geom_sf(data = sample_mg_pt, color = "blue", size = 5, inherit.aes = FALSE) +
  scale_fill_viridis_c() +
  ggtitle("Electricity Access Probability by Building at a Mini-Grid Site") +
  theme_bw() + 
  # theme(text = element_text(size = 28, family = "serif")) +
  # move legend to the bottom
  theme(legend.position = "bottom") 
  # remove long and lat axis labels
  # theme(axis.text.x = element_blank(), axis.text.y = element_blank()) +
  # add a scale bar
  # scalebar(x.min = left, x.max = right, y.min = bottom, y.max = top, dist = 1000, dist_unit = "m", st.dist = 0.1, st.dist_unit = "km")
ggsave("figures/oemap/access_prob_by_building_stadia_14.png", width = 12, height = 12, units = "in", dpi = 300)
```

## Loop Over All Mini-Grid Sites
```{r}
# read in the mini-grid sites
mgs <- st_read("data/oemap/mgs_28_buffer_1km.geojson")
# filter out nas
# mgs <- mgs %>% filter(!is.na(grid_cell_id))

# convert to list for lapply
mgs_list <- lapply(1:nrow(mgs), function(i) mgs[i, , drop = FALSE])

# Define the function
process_minigrid_site <- function(mg_feature) {
    print(paste0("Now processing: ", mg_feature$site_name))
    # Extract grid_cell_id from the current mini-grid site feature
    grid_cell_id <- mg_feature$grid_cell_id
    
    # Create filename in the specified format
    filename <- paste0("data/oemap/grid_cells_geojson/", grid_cell_id, "_geoms.geojson")
    
    # Read in the corresponding grid cell file
    grid_cell <- st_read(filename)
    
    # Clean the geometries
    grid_cell <- st_make_valid(grid_cell)
    
    # Grab just the features from grid_cell that intersect with the current mini-grid site
    inter <- st_intersection(grid_cell, mg_feature)
    
    # Calculate the mean, count, and standard deviation of elec.access
    # Replace 'elec.access' with the correct column name if different
    mean_elec_access <- mean(inter$elec.access...., na.rm = TRUE)
    count_elec_access <- nrow(inter)
    sd_elec_access <- sd(inter$elec.access...., na.rm = TRUE)
    
    # find the centroid of sample_mg as it's own sf
    mg_feature_pt <- st_centroid(mg_feature)
    # set crs of mg_feature to 4326
    st_crs(mg_feature) <- 4326
    st_crs(inter) <- 4326
    # caculate the distance from the village center to each building center
    inter$distance <- st_distance(inter, mg_feature_pt)

    # Return a list containing the results
    return(list(
      mean = mean_elec_access, 
      count = count_elec_access, 
      sd = sd_elec_access,
      distance = inter$distance,
      prob_elec_access = inter$elec.access....
    ))
}

# Example usage with lapply (assuming 'mgs' is already read and available)
# Note: mgs should be a list of sf features. If mgs is an sf object, convert it to a list of features.
# This can be done using something like `lapply(1:nrow(mgs), function(i) mgs[i,])`
results <- lapply(mgs_list, process_minigrid_site)

# convert results to a data frame
results <- do.call(rbind, results)

# add results to mgs
mgs <- cbind(mgs, results)

# convert mean, count, and sd to numeric from list columns
mgs$mean <- as.numeric(mgs$mean)
mgs$count <- as.numeric(mgs$count)
mgs$sd <- as.numeric(mgs$sd)

glimpse(mgs)
# save mgs
st_write(mgs, "data/oemap/mgs_28_buffer_results.geojson")
```

## Look at the results
```{r}
mgs <- st_read("data/oemap/mgs_28_buffer_results.geojson")
# filter out the NAs
mgs <- mgs %>% filter(!is.na(mean))
# 27 left

# plot the distribution of mean elec.access with density, fill by country
density_by_country <- ggplot(mgs) +
  geom_density(aes(x = mean, fill = country), alpha = 0.5, ) +
  ggtitle("Density Plot of Mean Electricity Access Probability by Mini-Grid Site") +
  labs(x = "Mean Electricity Access Probability of Mini-Grid Sites (%)", y = "Density") +
  theme_bw()
  # theme(text = element_text(size = 24, family = "serif"), legend.position = "bottom")
density_by_country
ggsave("figures/oemap/density_by_country_14.png", density_by_country, width = 16, height = 8, units = "in", dpi = 300)

# density plot of mean, fill with darkgreen
density_overall <- ggplot(mgs) +
  geom_density(aes(x = mean), fill = "darkgreen", alpha = 0.5) +
  ggtitle("Density Plot of Mean Electricity Access Probability by Mini-Grid Site") +
  labs(x = "Mean Electricity Access Probability of Mini-Grid Sites (%)", y = "Density") +
  theme_bw()
  # theme(text = element_text(size = 24, family = "serif"), legend.position = "bottom")
density_overall
ggsave("figures/oemap/density_overall_14.png", density_overall, width = 16, height = 8, units = "in", dpi = 300)

# create a summary table of the mean, count, and sd by coutnry
mgs_df <- st_drop_geometry(mgs)
mgs_summary <- mgs_df %>% 
  group_by(country) %>% 
  summarise(
    building_count = sum(count), 
    avg_num_buildings = mean(count),
    n_grids = n(),
    mean_access_prob = mean(mean), 
    sd_access_prob = mean(sd, na.rm = TRUE),
    earliest_grid = min(date_commissioned),
    latest_grid = max(date_commissioned)
  )
  # print entire df, don't let it get truncated
print(mgs_summary, width = Inf)

# scatterplot of prob_elec_access by distance from village center
ggplot(mgs) +
  geom_point(aes(x = distance, y = prob_elec_access)) +
  # geom_smooth(aes(x = distance, y = prob_elec_access), method = "gam", se = TRUE) +
  ggtitle("Electricity Access Probability by Building at a Mini-Grid Site") +
  labs(x = "Distance from Village Center", y = "Electricity Access Probability (%)") +
  theme_bw()
  # theme(text = element_text(size = 24, family = "serif"), legend.position = "bottom")
```

## Other Charts Not Used in Paper
```{r}

# plot box and whisker plot of mean
ggplot(mgs) +
  geom_boxplot(aes(y = mean)) +
  ggtitle("Boxplot of Mean Electricity Access Probability by Mini-Grid Site") +
  theme_bw()

# plot date_commissioned on the x versus mean on the y
ggplot(mgs) +
  geom_point(aes(x = date_commissioned, y = mean)) +
  ggtitle("Electricity Access Probability by Mini-Grid Site Commission Date") +
  theme_bw() + 
  theme(text = element_text(size = 24, family = "serif"), legend.position = "bottom")

# plot histogram of mean
ggplot(mgs) +
  geom_histogram(aes(x = mean), binwidth = 5) +
  ggtitle("Histogram of Mean Electricity Access Probability by Mini-Grid Site") +
  theme_bw() +
  theme(text = element_text(size = 24, family = "serif"), legend.position = "bottom")


# plot histogram of commissioning dates
ggplot(mgs) +
  geom_histogram(aes(x = date_commissioned), binwidth = 365) +
  ggtitle("Histogram of Mini-Grid Site Commission Dates") +
  theme_bw() +
  theme(text = element_text(size = 24, family = "serif"), legend.position = "bottom")


# macro stats
summary(mgs$mean)
nrow(mgs)

# count the number of sites with < 50% mean
mgs %>% filter(mean < 50) %>% count()
```

## To Do
- Look at the other sites with high numbers of buildings and low access probabilities
- Map them and visualize them to see if they look like they would have a mini-grid
- Google about them to see if I can find any info confirming that there is a mini-grid there
- Cherry pick one to include in the paper
- Or maybe get more nuanced about it

- Number 27 Bani: https://kowryenergy.com/ > just 9 buildings!

