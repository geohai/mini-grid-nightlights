# Callaway & Sant'Anna Difference in Difference Analysis for a Staggered Treatment

This notebook uses the Callaway & Sant'Anna (2020) Difference in Difference analysis for a staggered treatment. 
The original paper can be found [here](https://www.sciencedirect.com/science/article/pii/S0304407620300253).
An online tutorial can be found [here](https://tilburgsciencehub.com/topics/analyze/causal-inference/did/staggered-did/).

## Load Packages
```{r}
library(tidyverse)
library(did)
library(lubridate)
library(sf)
```


## Read in Data & View Summary Statistics
```{r}
# read in data
pop_sf <- st_read("data/pop_africa/pop_clean.geojson")
glimpse(pop_sf)
pop_melt_sf <- st_read("data/pop_africa/pop_melt.geojson")

# convert date_commissioned to a date
pop_sf$date_commissioned <- as.Date(pop_sf$date_commissioned)
pop_sf$year_commissioned <- year(pop_sf$date_commissioned)
# create a histogram of commissioning dates by year
# add colors based on the integer year commissioned
ggplot(pop_sf, aes(x = year_commissioned, fill = year_commissioned)) +
    geom_histogram(binwidth = 1) +
    labs(title = "Histogram of Commissioning Dates by Year for CLUB-ER Data", x = "Year", y = "Count") +
    # large text, serif font
    theme_bw() +    
    theme(text = element_text(size = 28, family = "serif"))

# fetch a geojson file with the borders of the countries of the world from the internet
world <- st_read("https://d2ad6b4ur7yvpq.cloudfront.net/naturalearth-3.3.0/ne_110m_admin_0_countries.geojson")

# view the data with geom_sf as points sized and colored by log('X2020') values
ggplot(pop_sf) +
    geom_sf(aes(size = X2020, color = log(X2020))) +
    scale_color_viridis_c() +
    scale_size(range = c(1, 20)) +
    labs(title = "Community Population in 2020", x = "Longitude", y = "Latitude") +
    theme_bw() + 
    xlim(-20, 50) +
    ylim(-30, 30) +
    theme(text = element_text(size = 28, family = "serif")) +
    # add in a background outline of countries in africa
    geom_sf(data = world, fill = NA, color = "black")

# visualize a histogram of the mean population by site_name with x and y log scales
ggplot(pop_melt_sf, aes(x = population)) +
    geom_histogram(bins = 30) +
    scale_x_log10() +
    scale_y_log10() +
    labs(title = "Histogram of Population Readings", x = "Population", y = "Count") +
    theme_bw() +
    theme(text = element_text(size = 28, family = "serif"))

glimpse(pop_sf)

# check for any duplicates based on geometry
dups <- pop_sf %>%
    group_by(geometry) %>%
    summarise(n = n()) %>%
    filter(n > 1) # 0

# total rows that contain a duplicate site_name
sum(dups$n) # 0
```

## Convert Column Types
```{r}
# read in the data
pop_melt_sf <- st_read("data/pop_africa/pop_melt.geojson")
df <- pop_melt_sf
glimpse(df)

# create a unique id for each site based on the geometry
df$id <- as.integer(as.factor(as.character(df$geometry)))

# change date_commissioned to year_commissioned
df$year_commissioned <- year(df$date_commissioned)

# rename year to year_pop
df <- df %>%
    rename(year_pop = year, year_commissioned = date_commissioned)

glimpse(df)

# export as RDS
saveRDS(df, "data/pop_africa/pop_melt_sf.rds")
```

## Handle Outliers
Import Data & Calculate Medians & IQRs by ID
```{r}
# reread in data
pop_melt_sf <- readRDS("data/pop_africa/pop_melt_sf.rds")
df <- pop_melt_sf

# find the median for each id, put it into a new column
df$median <- ave(df$population, df$id, FUN = median)
# find the upper 75% quartile for each id, put it into a new column
df$q3 <- ave(df$population, df$id, FUN = function(x) quantile(x, 0.75))
# find the lower 25% quartile for each id, put it into a new column
df$q1 <- ave(df$population, df$id, FUN = function(x) quantile(x, 0.25))
# calculate the IQR for each id, put it into a new column
df$IQR <- df$q3 - df$q1
# calculate the top whisker for each id, put it into a new column
df$top_whisker <- df$q3 + 1.5 * df$IQR
# calculate the bottom whisker for each id, put it into a new column
df$bottom_whisker <- df$q1 - 1.5 * df$IQR

glimpse(df)
# count the number of outliers in the data
df %>%
    st_drop_geometry() %>%
    filter(population > top_whisker | population < bottom_whisker) %>%
    count() ## 438 / 21k

# convert any population that is above the top whisker to the top whisker
df <- df %>%
    mutate(population = ifelse(population > top_whisker, top_whisker, population))
# convert any population that is below the bottom whisker to the bottom whisker
df <- df %>%
    mutate(population = ifelse(population < bottom_whisker, bottom_whisker, population))

# drop the columns median, q1, q3, IQR, top_whisker, and bottom_whisker
df <- df %>%
    select(-median, -q1, -q3, -IQR, -top_whisker, -bottom_whisker)

# export 
saveRDS(df, "data/pop_africa/pop_melt_sf_clean.rds")
```

## Create Some Visualizations
```{r}
# read in the data
df <- readRDS("data/pop_africa/pop_melt_sf_clean.rds")

# remove rows that have na in any column
df <- df %>%
    filter(!is.na(population)) %>%
    filter(!is.nan(population)) %>%
    filter(!is.infinite(population))

any(is.nan(df$type))

glimpse(df)
# plot the population by year by site_type
ggplot(df, aes(x = year_pop, y = population, color = type)) +
   geom_smooth(method = 'gam', formula = y ~ s(x, bs = "tp")) +
    labs(title = "Population by Year by Site Type", x = "Year", y = "Population") +
    theme_bw() +
    theme(text = element_text(size = 28, family = "serif"), legend.position = "bottom")

# make a line plot of each site's population by year
ggplot(df, aes(x = year_pop, y = population, group = id, color = id)) +
    geom_line() +
    labs(title = "Population by Year by Site", x = "Year", y = "Population") +
    theme_bw()
```

## Pull Out Summary Statistics
```{r}
# read in the data
df <- readRDS("data/pop_africa/pop_melt_sf_clean.rds")

# drop geometry column
df <- st_drop_geometry(df)
# group by type and give me the sd, mean, min, max, and median of each
summary_stats <- df %>%
    group_by(type) %>%
    summarise(
        sd = sd(population),
        mean = mean(population),
        min = min(population),
        max = max(population),
        median = median(population)
    )
# round all values to 0 decimal places
summary_stats <- summary_stats %>%
    mutate_if(is.numeric, ~round(., 0))

# print results
summary_stats
```

## Data Requirements
- There must be a unit-specific identifier variable that does not vary over time, integer format. Here that is id.
- There must be a time variable. Here that is year_pop.
- There must be a group variable, which is usually the period when an individual first becomes treated. For units that are never treated, this variable should be set to 0! Here that is year_commissioned.
- The variables must be of numeric class.
Note: this analysis can be run without control sites! Worth re-running on the CLUB-ER dataset. 

## Prep Data for DinD
```{r}
# read in data
df <- readRDS("data/pop_africa/pop_melt_sf_clean.rds")

# pull out the earliest date
start_year <- min(df$year_pop)
end_year <- max(df$year_pop)

# check for any NA values in any column
df %>% st_drop_geometry() %>% summarise_all(~sum(is.na(.)))

df$time_period <- df$year_pop - start_year + 1
df$group <- df$year_commissioned - start_year + 1

# plot histogram of group variable
# set y max to 25
ggplot(df, aes(x = group)) +
    geom_histogram(binwidth = 1) +
    xlim(-1, 25) +
    labs(title = "Histogram of Group Variable", x = "Group", y = "Count") +
    theme_bw()

# export df to RDS
saveRDS(df, "data/pop_africa/pop_melt_sf_clean_dind.rds")
```

## Run the DinD Analysis
```{r}
# read in the data
df <- readRDS("data/pop_africa/pop_melt_sf_clean_dind.rds")

# keep just the mini-grid sites
df <- df %>%
    filter(type == "mini-grid")

# run the model
# https://bcallaway11.github.io/did/reference/att_gt.html
did_notyettreated <- att_gt(
    yname = "population", # outcome variable
    tname = "time_period", # time variable
    idname = "id", # id variable
    gname = "group", # first treatment period variable
    data = df, # data
    control_group = "notyettreated", # set the comparison group as either "never treated" or "not yet treated"
)

# aggregate the results
did_notyettreated_agg <- aggte(
    did_notyettreated,
    type = "dynamic", 
    na.rm = TRUE
)
# view the results
summary(did_notyettreated_agg)

# plot group-time ATTs
did_notyettreated_agg_plt <- ggdid(did_notyettreated_agg) +
    labs(title = "Group-Time ATTs on Population using Not Yet Treated as Controls", x = "Years from Mini-Grid Commissioning", y = "Change in Population") +
    theme_bw() + 
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
    theme(text = element_text(size = 28, family = "serif"), legend.position = "bottom")
ggsave("figures/pop_africa/did_notyettreated.png", did_notyettreated_agg_plt, width = 16, height = 10, units = "in", dpi = 300)

print(did_notyettreated_agg_plt)
```
Warnings while running model:
Warning message:
In att_gt(yname = "population", tname = "time_period", idname = "id",  :
  Not returning pre-test Wald statistic due to singular covariance matrix

## Results
Reference: Callaway, Brantly and Pedro H.C. Sant'Anna.  "Difference-in-Differences with Multiple Time Periods." Journal of Econometrics, Vol. 225, No. 2, pp. 200-230, 2021. <https://doi.org/10.1016/j.jeconom.2020.12.001>, <https://arxiv.org/abs/1803.09015> 

Overall summary of ATT's based on event-study/dynamic aggregation:  
      ATT    Std. Error     [ 95%  Conf. Int.]  
 400.3807      117.1817   170.7088    630.0526 *

Dynamic Effects:
 Event time  Estimate Std. Error [95% Simult.  Conf. Band]  
        -18   68.7354   122.5022     -259.5730    397.0439  
        -17  -33.4148    13.0991      -68.5207      1.6911  
        -16  -24.8981     9.6327      -50.7140      0.9179  
        -15   -7.2556    12.5177      -40.8035     26.2922  
        -14  -40.7845     7.9508      -62.0927    -19.4762 *
        -13    3.4886    11.7226      -27.9282     34.9055  
        -12    1.7474    23.5947      -61.4870     64.9818  
        -11  -25.4939    19.1719      -76.8750     25.8871  
        -10    6.5080     7.6745      -14.0600     27.0759  
         -9   -6.9291     7.9101      -28.1284     14.2701  
         -8   -3.5860    10.8972      -32.7907     25.6187  
         -7   -4.0123     8.2958      -26.2451     18.2206  
         -6   -4.7062    15.3090      -45.7345     36.3222  
         -5   30.6904    11.4764       -0.0665     61.4473  
         -4    7.6808    21.1828      -49.0894     64.4511  
         -3   -3.7052    11.3226      -34.0499     26.6396  
         -2   10.3295     9.6467      -15.5239     36.1828  
         -1   23.9237    14.9466      -16.1335     63.9809  
          0   21.0134    11.3548       -9.4176     51.4445  
          1   27.6182    14.5162      -11.2856     66.5220  
          2   87.2917    28.4615       11.0143    163.5691 *
          3  113.1320    43.2518       -2.7838    229.0478  
          4  166.7190    72.6907      -28.0936    361.5316  
          5  291.5686   123.1787      -38.5531    621.6902  
          6  414.8528   140.0925       39.4019    790.3038 *
          7  525.9526   222.3423      -69.9295   1121.8348  
          8  610.0534   290.4164     -168.2689   1388.3757  
          9  280.0716   244.9305     -376.3473    936.4905  
         10  327.0141   293.7692     -460.2938   1114.3220  
         11  226.6068   144.8668     -161.6392    614.8529  
         12   65.7440   101.2127     -205.5083    336.9962  
         13  183.6055   135.9639     -180.7808    547.9917  
         14  340.1363   164.3973     -100.4519    780.7245  
         15  685.3522   311.2685     -148.8542   1519.5585  
         16  671.8111   338.0202     -234.0904   1577.7125  
         17  939.2947   385.0179      -92.5616   1971.1511  
         18 1629.3956   594.2047       36.9142   3221.8770 *


## Run the DinD Analysis
```{r}
# read in the data
df <- readRDS("data/pop_africa/pop_melt_sf_clean_dind.rds")

# keep just the mini-grid & urban sites
df <- df %>%
    filter(type == "mini-grid" | type == "desert")

# run the model
# https://bcallaway11.github.io/did/reference/att_gt.html
did <- att_gt(
    yname = "population", # outcome variable
    tname = "time_period", # time variable
    idname = "id", # id variable
    gname = "group", # first treatment period variable
    data = df, # data
    control_group = "nevertreated", # set the comparison group as either "never treated" or "not yet treated"
)

# aggregate the results
did_agg <- aggte(
    did,
    type = "dynamic", 
    na.rm = TRUE
)
# view the results
summary(did_agg)

# plot group-time ATTs
did_agg_plt <- ggdid(did_agg) +
    labs(title = "Group-Time ATTs on Population using Desert Areas as Controls", x = "Years from Mini-Grid Commissioning", y = "Change in Population") +
    theme_bw() + 
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1)) +
    theme(text = element_text(size = 16, family = "serif"), legend.position = "bottom")
ggsave("figures/pop_africa/did_mg_desert.png", did_agg_plt, width = 8, height = 6, units = "in", dpi = 300)

print(did_agg_plt)
```

## Results
Reference: Callaway, Brantly and Pedro H.C. Sant'Anna.  "Difference-in-Differences with Multiple Time Periods." Journal of Econometrics, Vol. 225, No. 2, pp. 200-230, 2021. <https://doi.org/10.1016/j.jeconom.2020.12.001>, <https://arxiv.org/abs/1803.09015> 

Mini-Grids vs. Built-Up Areas  
       ATT    Std. Error     [ 95%  Conf. Int.]  
 -1803.237      256.9554   -2306.86   -1299.614 *

Mini-Grids vs. Rural Areas
      ATT    Std. Error     [ 95%  Conf. Int.]  
 582.8797      123.7333   340.3668    825.3926 *

 Mini-Grids vs. Rainforest Areas
       ATT    Std. Error     [ 95%  Conf. Int.]  
 588.1131      118.4676   355.9209    820.3052 *

 Mini-Grids vs. Desert Areas
      ATT    Std. Error     [ 95%  Conf. Int.]  
 597.5045      112.1513    377.692    817.3171 *
